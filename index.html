<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CardVault ‚Äî PSA Collection Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --gold: #C9A84C; --gold-light: #E8C96A; --gold-dim: #8A6E2F;
  --bg: #0D0F14; --bg2: #13161E; --bg3: #1A1E2A; --bg4: #222736;
  --border: #2A2F3F; --text: #E8E4D8; --text-dim: #7A7D8A; --text-muted: #4A4D5A;
  --green: #4CAF82; --red: #CF5A5A; --blue: #7099DC;
}
body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; }
.app {
  min-height: 100vh; background: var(--bg);
  background-image: radial-gradient(ellipse at 20% 0%, rgba(201,168,76,0.06) 0%, transparent 50%),
                    radial-gradient(ellipse at 80% 100%, rgba(201,168,76,0.04) 0%, transparent 50%);
}
.header {
  border-bottom: 1px solid var(--border); padding: 16px 20px;
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(13,15,20,0.97); backdrop-filter: blur(10px);
  position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 10px;
}
.header-brand { display: flex; align-items: center; gap: 12px; }
.brand-icon { width: 34px; height: 34px; border: 1.5px solid var(--gold); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 15px; }
.brand-title { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; }
.brand-subtitle { font-size: 9px; color: var(--gold); letter-spacing: 0.2em; text-transform: uppercase; font-family: 'DM Mono', monospace; }
.header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.bell-btn {
  position: relative; background: transparent; border: 1px solid var(--border); border-radius: 4px;
  width: 34px; height: 34px; display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 15px; transition: all 0.2s; color: var(--text-dim);
}
.bell-btn:hover, .bell-btn.has-unread { border-color: var(--gold-dim); color: var(--gold); }
.bell-btn.has-unread { animation: bellPulse 2.5s ease infinite; }
@keyframes bellPulse { 0%,100%{box-shadow:0 0 0 0 rgba(201,168,76,0)} 50%{box-shadow:0 0 0 5px rgba(201,168,76,0.12)} }
.bell-badge {
  position: absolute; top: -6px; right: -6px; background: var(--gold); color: #0D0F14;
  font-size: 9px; font-weight: 700; font-family: 'DM Mono', monospace;
  border-radius: 10px; min-width: 16px; height: 16px;
  display: flex; align-items: center; justify-content: center; padding: 0 4px; border: 1.5px solid var(--bg);
}
.countdown-chip {
  display: inline-flex; align-items: center; gap: 6px; background: var(--bg3);
  border: 1px solid var(--border); border-radius: 4px; padding: 5px 10px;
  font-size: 10px; font-family: 'DM Mono', monospace; color: var(--text-dim);
}
.live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: blink 2s ease infinite; flex-shrink: 0; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
.btn {
  padding: 7px 14px; border-radius: 4px; font-size: 11px; font-weight: 500;
  cursor: pointer; transition: all 0.2s; letter-spacing: 0.05em; text-transform: uppercase;
  font-family: 'DM Mono', monospace; border: none; white-space: nowrap;
}
.btn-gold { background: var(--gold); color: #0D0F14; }
.btn-gold:hover { background: var(--gold-light); }
.btn-gold:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-outline { background: transparent; color: var(--gold); border: 1px solid var(--gold-dim); }
.btn-outline:hover { border-color: var(--gold); background: rgba(201,168,76,0.08); }
.btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--border); padding: 5px 10px; }
.btn-ghost:hover { color: var(--text); border-color: var(--text-muted); }
.btn-danger { background: transparent; color: var(--red); border: 1px solid rgba(207,90,90,0.3); padding: 5px 8px; font-size: 10px; }
.btn-danger:hover { background: rgba(207,90,90,0.1); }
.btn-xs { padding: 4px 8px; font-size: 10px; }
.main { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
@media(min-width:700px){ .stats-grid { grid-template-columns: repeat(4,1fr); } }
.stat-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; position: relative; overflow: hidden; }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent); opacity: 0.5; }
.stat-label { font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-dim); font-family: 'DM Mono', monospace; margin-bottom: 6px; }
.stat-value { font-family: 'Playfair Display', serif; font-size: 24px; color: var(--text); line-height: 1; }
.stat-value.gold { color: var(--gold); }
.stat-sub { font-size: 10px; color: var(--text-dim); margin-top: 5px; font-family: 'DM Mono', monospace; }
.section-header { display: flex; align-items: center; margin-bottom: 14px; }
.section-title { font-family: 'Playfair Display', serif; font-size: 17px; color: var(--text); white-space: nowrap; }
.section-line { flex: 1; height: 1px; background: var(--border); margin-left: 14px; }
.card-table { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 24px; }
.table-scroll { overflow-x: auto; }
.table-head { display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 0.6fr 1fr 1fr 0.9fr 0.5fr; padding: 10px 16px; background: var(--bg3); border-bottom: 1px solid var(--border); min-width: 700px; }
.th { font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-dim); font-family: 'DM Mono', monospace; }
.table-row { display: grid; grid-template-columns: 2fr 0.8fr 0.8fr 0.6fr 1fr 1fr 0.9fr 0.5fr; padding: 12px 16px; border-bottom: 1px solid var(--border); align-items: center; transition: background 0.15s; min-width: 700px; }
.table-row:last-child { border-bottom: none; }
.table-row:hover { background: var(--bg3); }
.card-name { font-weight: 500; font-size: 13px; color: var(--text); }
.card-meta { font-size: 10px; color: var(--text-dim); font-family: 'DM Mono', monospace; margin-top: 2px; }
.td { font-size: 12px; color: var(--text-dim); font-family: 'DM Mono', monospace; }
.td-value { font-size: 13px; font-weight: 500; color: var(--gold); font-family: 'DM Mono', monospace; }
.psa-badge { display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 4px; font-family: 'Playfair Display', serif; font-weight: 700; font-size: 13px; }
.psa-10 { background: rgba(76,175,130,0.15); color: #4CAF82; border: 1px solid rgba(76,175,130,0.3); }
.psa-9 { background: rgba(201,168,76,0.12); color: var(--gold); border: 1px solid rgba(201,168,76,0.3); }
.psa-8 { background: rgba(100,140,220,0.12); color: #7099DC; border: 1px solid rgba(100,140,220,0.3); }
.psa-other { background: rgba(120,120,140,0.12); color: var(--text-dim); border: 1px solid var(--border); }
.status-pill { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 20px; font-size: 9px; font-family: 'DM Mono', monospace; }
.status-live { background: rgba(76,175,130,0.12); color: #4CAF82; border: 1px solid rgba(76,175,130,0.2); }
.status-pending { background: rgba(201,168,76,0.1); color: var(--gold-dim); border: 1px solid rgba(201,168,76,0.2); }
.status-loading { background: rgba(100,140,220,0.1); color: #7099DC; border: 1px solid rgba(100,140,220,0.2); }
.status-error { background: rgba(207,90,90,0.1); color: var(--red); border: 1px solid rgba(207,90,90,0.2); }
.dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
.new-badge { display: inline-block; margin-left: 6px; background: var(--gold); color: #0D0F14; border-radius: 10px; font-size: 8px; padding: 1px 6px; font-family: 'DM Mono', monospace; font-weight: 700; vertical-align: middle; }
.empty-state { padding: 50px 20px; text-align: center; }
.empty-icon { font-size: 44px; margin-bottom: 14px; opacity: 0.4; }
.empty-title { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--text-dim); margin-bottom: 6px; }
.empty-sub { font-size: 12px; color: var(--text-muted); }
.progress-bar-wrap { background: var(--bg3); border-radius: 2px; height: 3px; overflow: hidden; margin-bottom: 20px; }
.progress-bar { height: 100%; background: linear-gradient(90deg, var(--gold-dim), var(--gold)); border-radius: 2px; transition: width 0.5s ease; }
.alert { padding: 12px 14px; border-radius: 6px; font-size: 11px; font-family: 'DM Mono', monospace; margin-bottom: 14px; line-height: 1.7; }
.alert-info { background: rgba(100,140,220,0.08); border: 1px solid rgba(100,140,220,0.18); color: var(--blue); }
.refresh-icon { display: inline-block; }
.spinning { animation: spin 1s linear infinite; }
@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

/* Notification Drawer */
.notif-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 200; }
.notif-drawer { position: fixed; top: 0; right: 0; bottom: 0; width: min(390px, 100vw); background: var(--bg2); border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 201; animation: slideInRight 0.25s ease; }
@keyframes slideInRight { from{transform:translateX(100%)} to{transform:translateX(0)} }
.notif-header { padding: 18px 16px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.notif-title { font-family: 'Playfair Display', serif; font-size: 17px; }
.notif-hactions { display: flex; gap: 6px; }
.notif-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
.notif-list::-webkit-scrollbar { width: 4px; }
.notif-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.notif-item { background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; padding: 12px; position: relative; }
.notif-item.unread { border-color: rgba(201,168,76,0.3); background: rgba(201,168,76,0.035); }
.notif-item.unread::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 55%; background: var(--gold); border-radius: 0 2px 2px 0; }
.notif-card-name { font-size: 12px; font-weight: 500; color: var(--text); margin-bottom: 4px; }
.notif-price { font-family: 'DM Mono', monospace; font-size: 18px; color: var(--gold); font-weight: 500; }
.notif-meta { font-size: 10px; color: var(--text-dim); font-family: 'DM Mono', monospace; margin-top: 3px; }
.notif-vs { display: flex; gap: 16px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
.notif-vs-label { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); font-family: 'DM Mono', monospace; }
.notif-vs-val { font-size: 11px; font-family: 'DM Mono', monospace; color: var(--text-dim); margin-top: 2px; }
.notif-time { font-size: 10px; color: var(--text-muted); font-family: 'DM Mono', monospace; margin-top: 6px; }
.notif-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; color: var(--text-muted); text-align: center; padding: 40px 20px; gap: 10px; }
.notif-empty-icon { font-size: 40px; opacity: 0.3; }
.notif-empty-text { font-size: 12px; line-height: 1.7; }
.notif-footer { padding: 10px 16px; border-top: 1px solid var(--border); font-size: 10px; color: var(--text-muted); font-family: 'DM Mono', monospace; text-align: center; }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 300; padding: 16px; }
.modal { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; width: 460px; max-width: 100%; animation: slideUp 0.25s ease; max-height: 90vh; overflow-y: auto; }
@keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
.modal-header { padding: 18px 20px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg2); z-index: 1; }
.modal-title { font-family: 'Playfair Display', serif; font-size: 17px; }
.modal-body { padding: 20px; display: flex; flex-direction: column; gap: 14px; }
.modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; position: sticky; bottom: 0; background: var(--bg2); }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-dim); font-family: 'DM Mono', monospace; }
.form-input, .form-select { background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; padding: 9px 12px; font-size: 14px; color: var(--text); font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.15s; width: 100%; }
.form-input:focus, .form-select:focus { border-color: var(--gold-dim); }
.form-select option { background: var(--bg3); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* Toast */
.toast-wrap { position: fixed; bottom: 20px; right: 16px; display: flex; flex-direction: column-reverse; gap: 8px; z-index: 500; pointer-events: none; max-width: calc(100vw - 32px); }
.toast { background: var(--bg3); border: 1px solid rgba(201,168,76,0.45); border-radius: 8px; padding: 12px 16px; min-width: 220px; box-shadow: 0 8px 32px rgba(0,0,0,0.45); animation: toastIn 0.3s ease; pointer-events: all; }
@keyframes toastIn { from{opacity:0;transform:translateX(40px)} to{opacity:1;transform:translateX(0)} }
.toast-eyebrow { font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--gold-dim); font-family: 'DM Mono', monospace; margin-bottom: 3px; }
.toast-card { font-size: 12px; font-weight: 500; color: var(--text); }
.toast-price { font-size: 18px; font-family: 'DM Mono', monospace; color: var(--gold); margin-top: 2px; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

const POLL_MS = 6 * 60 * 60 * 1000;
const PSA_GRADES = [10,9,8,7,6,5,4,3,2,1,"Auth"];
const EMPTY_FORM = { player:"", year:"", brand:"", cardNumber:"", grade:10, quantity:1, pricePaid:"" };

function getPsaClass(g) {
  const n = Number(g);
  if (n===10) return "psa-10";
  if (n===9) return "psa-9";
  if (n===8) return "psa-8";
  return "psa-other";
}

const fmt$ = v => v!=null ? "$"+Number(v).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}) : "‚Äî";
const fmtDate = iso => iso ? new Date(iso).toLocaleDateString("en-US",{month:"short",day:"numeric"}) : null;

function timeAgo(iso) {
  if (!iso) return "";
  const m = Math.floor((Date.now()-new Date(iso))/60000);
  if (m<1) return "Just now";
  if (m<60) return m+"m ago";
  const h = Math.floor(m/60);
  if (h<24) return h+"h ago";
  return Math.floor(h/24)+"d ago";
}

function fmtCountdown(ms) {
  if (ms<=0) return "checking‚Ä¶";
  const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}

const saleKey = s => s.date+"::"+s.price;

// Simple localStorage wrapper (works in any browser)
const store = {
  get(k) { try { const v=localStorage.getItem(k); return v?JSON.parse(v):null; } catch(e){ return null; } },
  set(k,v) { try { localStorage.setItem(k,JSON.stringify(v)); } catch(e){} },
  getRaw(k) { try { return localStorage.getItem(k)||null; } catch(e){ return null; } },
  setRaw(k,v){ try { localStorage.setItem(k,v); } catch(e){} },
};

function SetupScreen({onSave}) {
  const [key, setKey] = useState("");
  const [err, setErr] = useState("");
  const save = () => {
    const k = key.trim();
    if (!k.startsWith("sk-ant-")) { setErr("That doesn't look like a valid Anthropic key ‚Äî it should start with sk-ant-"); return; }
    store.setRaw("cv-apikey", k);
    onSave(k);
  };
  return (
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",padding:24,background:"var(--bg)"}}>
      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:10,width:"100%",maxWidth:440,padding:32}}>
        <div style={{textAlign:"center",marginBottom:28}}>
          <div style={{fontSize:40,marginBottom:12}}>üèÜ</div>
          <div style={{fontFamily:"'Playfair Display',serif",fontSize:24,marginBottom:6}}>CardVault</div>
          <div style={{fontSize:11,color:"var(--text-dim)",fontFamily:"'DM Mono',monospace",letterSpacing:"0.15em",textTransform:"uppercase"}}>PSA Collection Tracker</div>
        </div>
        <div style={{marginBottom:10,fontSize:13,color:"var(--text-dim)",lineHeight:1.7}}>
          To look up eBay sale prices, CardVault needs your Anthropic API key. It's stored <strong style={{color:"var(--text)"}}>only on your device</strong> and never sent anywhere except Anthropic's servers.
        </div>
        <div style={{marginBottom:6,fontSize:9,letterSpacing:"0.15em",textTransform:"uppercase",color:"var(--text-dim)",fontFamily:"'DM Mono',monospace"}}>Anthropic API Key</div>
        <input
          className="form-input"
          type="password"
          placeholder="sk-ant-..."
          value={key}
          onChange={e=>{setKey(e.target.value);setErr("");}}
          style={{marginBottom:8}}
        />
        {err && <div style={{fontSize:11,color:"var(--red)",marginBottom:10,fontFamily:"'DM Mono',monospace"}}>{err}</div>}
        <button className="btn btn-gold" onClick={save} style={{width:"100%",padding:12,fontSize:13}}>Save & Launch CardVault</button>
        <div style={{marginTop:14,fontSize:10,color:"var(--text-muted)",fontFamily:"'DM Mono',monospace",textAlign:"center",lineHeight:1.7}}>
          Get a free key at console.anthropic.com ‚Üí API Keys
        </div>
      </div>
    </div>
  );
}

function App() {
  const [apiKey,setApiKey] = useState(()=>store.getRaw("cv-apikey"));
  const [cards,setCards] = useState([]);
  const [notifs,setNotifs] = useState([]);
  const [showDrawer,setShowDrawer] = useState(false);
  const [showModal,setShowModal] = useState(false);
  const [form,setForm] = useState(EMPTY_FORM);
  const [loadingMap,setLoadingMap] = useState({});
  const [updatingAll,setUpdAll] = useState(false);
  const [progress,setProgress] = useState(0);
  const [toasts,setToasts] = useState([]);
  const [countdown,setCountdown] = useState(POLL_MS);
  const [loaded,setLoaded] = useState(false);

  const cardsRef = useRef(cards);
  const notifsRef = useRef(notifs);
  const updRef = useRef(updatingAll);
  useEffect(()=>{ cardsRef.current=cards; },[cards]);
  useEffect(()=>{ notifsRef.current=notifs; },[notifs]);
  useEffect(()=>{ updRef.current=updatingAll; },[updatingAll]);

  // Load
  useEffect(()=>{
    const c = store.get("cv-cards");
    const n = store.get("cv-notifs");
    const t = store.get("cv-poll");
    if (c) setCards(c);
    if (n) setNotifs(n);
    if (t) setCountdown(Math.max(0, POLL_MS-(Date.now()-t)));
    setLoaded(true);
  },[]);

  const saveCards = useCallback(v=>{ setCards(v); store.set("cv-cards",v); },[]);
  const saveNotifs = useCallback(v=>{ setNotifs(v); store.set("cv-notifs",v); },[]);

  const addToast = useCallback((cardLabel,sale)=>{
    const id=Date.now()+Math.random();
    setToasts(t=>[...t,{id,cardLabel,sale}]);
    setTimeout(()=>setToasts(t=>t.filter(x=>x.id!==id)),5500);
  },[]);

  const fetchCardValue = async card => {
    const q=`${card.year?card.year+" ":""}${card.brand?card.brand+" ":""}${card.player}${card.cardNumber?" #"+card.cardNumber:""} PSA ${card.grade} eBay sold`;
    const prompt=`Search eBay completed/sold listings for: "${q}"\n\nReturn ONLY valid JSON (no markdown):\n{"estimatedValue":<number|null>,"recentSales":[{"date":"YYYY-MM-DD","price":<number>,"source":"eBay"}],"salesCount":<number>,"note":"<60 chars>"}\nIf no data: {"estimatedValue":null,"recentSales":[],"salesCount":0,"note":"No recent sales found"}`;
    const res=await fetch("/api/proxy",{
      method:"POST",headers:{"Content-Type":"application/json","x-api-key":store.getRaw("cv-apikey")||"","anthropic-version":"2023-06-01"},
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,tools:[{type:"web_search_20250305",name:"web_search"}],messages:[{role:"user",content:prompt}]})
    });
    const data=await res.json();
    const text=data.content.filter(b=>b.type==="text").map(b=>b.text).join("");
    const m=text.match(/\{[\s\S]*\}/);
    if(!m) throw new Error("No JSON");
    return JSON.parse(m[0]);
  };

  const processNewSales = useCallback((card,freshSales)=>{
    const known=new Set((card.recentSales||[]).map(saleKey));
    const newOnes=freshSales.filter(s=>!known.has(saleKey(s)));
    if(!newOnes.length) return [];
    const label=[card.year,card.brand,card.player].filter(Boolean).join(" ")+` PSA ${card.grade}`;
    const ns=newOnes.map(sale=>({
      id:`${card.id}-${saleKey(sale)}-${Date.now()}`,
      cardId:card.id, cardLabel:label, sale,
      previousValue:card.currentValue??null,
      seenAt:new Date().toISOString(), read:false,
    }));
    ns.forEach(n=>addToast(n.cardLabel,n.sale));
    return ns;
  },[addToast]);

  const updateCard = useCallback(async cardId=>{
    setLoadingMap(m=>({...m,[cardId]:true}));
    setCards(prev=>prev.map(c=>c.id===cardId?{...c,status:"loading"}:c));
    try {
      const card=cardsRef.current.find(c=>c.id===cardId);
      const result=await fetchCardValue(card);
      const freshSales=result.recentSales||[];
      const newNs=processNewSales(card,freshSales);
      if(newNs.length){ saveNotifs([...notifsRef.current,...newNs].slice(-150)); }
      saveCards(cardsRef.current.map(c=>c.id===cardId?{
        ...c,currentValue:result.estimatedValue,recentSales:freshSales,
        salesNote:result.note,lastUpdated:new Date().toISOString(),
        status:result.estimatedValue?"live":"error",
      }:c));
    } catch(_){
      saveCards(cardsRef.current.map(c=>c.id===cardId?{...c,status:"error",salesNote:"Update failed"}:c));
    }
    setLoadingMap(m=>({...m,[cardId]:false}));
  },[processNewSales,saveCards,saveNotifs]);

  const updateAll = useCallback(async()=>{
    if(updRef.current) return;
    setUpdAll(true); setProgress(0);
    const list=cardsRef.current;
    for(let i=0;i<list.length;i++){
      await updateCard(list[i].id);
      setProgress(Math.round(((i+1)/list.length)*100));
    }
    const now=Date.now();
    setCountdown(POLL_MS);
    store.set("cv-poll",now);
    setUpdAll(false); setProgress(0);
  },[updateCard]);

  // Countdown ticker
  useEffect(()=>{
    const t=setInterval(()=>setCountdown(c=>Math.max(0,c-1000)),1000);
    return ()=>clearInterval(t);
  },[]);

  // Auto-poll trigger
  useEffect(()=>{
    if(countdown===0 && cardsRef.current.length>0 && !updRef.current) updateAll();
  },[countdown,updateAll]);

  const unread=notifs.filter(n=>!n.read).length;

  const openDrawer=()=>{
    setShowDrawer(true);
    if(unread>0) setTimeout(()=>saveNotifs(notifsRef.current.map(n=>({...n,read:true}))),700);
  };

  const addCard=()=>{
    if(!form.player.trim()) return;
    const card={
      id:Date.now().toString(),...form,
      grade:isNaN(+form.grade)?form.grade:+form.grade,
      quantity:+form.quantity||1,
      pricePaid:form.pricePaid?+form.pricePaid:null,
      currentValue:null,recentSales:[],lastUpdated:null,status:"pending",
    };
    saveCards([...cardsRef.current,card]);
    setForm(EMPTY_FORM); setShowModal(false);
  };

  const removeCard=id=>{
    saveCards(cardsRef.current.filter(c=>c.id!==id));
    saveNotifs(notifsRef.current.filter(n=>n.cardId!==id));
  };

  const totalValue=cards.reduce((s,c)=>s+(c.currentValue?c.currentValue*(c.quantity||1):0),0);
  const totalCost =cards.reduce((s,c)=>s+(c.pricePaid?c.pricePaid*(c.quantity||1):0),0);
  const pnl=totalValue-totalCost;
  const pnlPct=totalCost>0?(pnl/totalCost)*100:0;

  if(!loaded) return null;
  if(!apiKey) return <SetupScreen onSave={k=>{setApiKey(k);}} />;

  return (
    <div className="app">
      {/* Header */}
      <header className="header">
        <div className="header-brand">
          <div className="brand-icon">üèÜ</div>
          <div>
            <div className="brand-title">CardVault</div>
            <div className="brand-subtitle">PSA Collection Tracker</div>
          </div>
        </div>
        <div className="header-actions">
          {cards.length>0 && (
            <div className="countdown-chip">
              <span className="live-dot"/>
              {fmtCountdown(countdown)}
            </div>
          )}
          {cards.length>0 && (
            <button className="btn btn-outline" onClick={updateAll} disabled={updatingAll}>
              <span className={`refresh-icon ${updatingAll?"spinning":""}`}>‚Üª</span>
              {updatingAll?` ${progress}%`:" Update All"}
            </button>
          )}
          <button className={`bell-btn ${unread>0?"has-unread":""}`} onClick={openDrawer} title="Sales alerts">
            üîî
            {unread>0 && <span className="bell-badge">{unread>99?"99+":unread}</span>}
          </button>
          <button className="btn btn-gold" onClick={()=>setShowModal(true)}>+ Add Card</button>
          <button className="btn btn-ghost" title="Change API key" onClick={()=>{if(window.confirm("Reset your API key?")){store.setRaw("cv-apikey","");setApiKey(null);}}} style={{padding:"5px 8px",fontSize:13}}>‚öôÔ∏è</button>
        </div>
      </header>

      <main className="main">
        {updatingAll && (
          <div className="progress-bar-wrap">
            <div className="progress-bar" style={{width:progress+"%"}}/>
          </div>
        )}

        {/* Stats */}
        <div className="stats-grid">
          <div className="stat-card">
            <div className="stat-label">Portfolio Value</div>
            <div className="stat-value gold">{totalValue>0?fmt$(totalValue):"‚Äî"}</div>
            <div className="stat-sub">{cards.filter(c=>c.currentValue).length}/{cards.length} valued</div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Total Invested</div>
            <div className="stat-value">{totalCost>0?fmt$(totalCost):"‚Äî"}</div>
            <div className="stat-sub">{cards.reduce((s,c)=>s+(c.quantity||1),0)} cards</div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Total P&L</div>
            <div className="stat-value" style={{color:pnl>=0?"var(--green)":"var(--red)"}}>
              {totalCost>0?(pnl>=0?"+":"")+fmt$(pnl):"‚Äî"}
            </div>
            <div className="stat-sub" style={{color:pnl>=0?"var(--green)":"var(--red)"}}>
              {totalCost>0?(pnlPct>=0?"+":"")+pnlPct.toFixed(1)+"%":"Add cost basis"}
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-label">Sales Alerts</div>
            <div className="stat-value" style={{color:unread>0?"var(--gold)":undefined}}>{notifs.length}</div>
            <div className="stat-sub">{unread>0?unread+" unread":"All caught up"}</div>
          </div>
        </div>

        {/* Table */}
        <div className="section-header">
          <div className="section-title">Collection</div>
          <div className="section-line"/>
        </div>
        <div className="card-table">
          {cards.length===0 ? (
            <div className="empty-state">
              <div className="empty-icon">üÉè</div>
              <div className="empty-title">No cards yet</div>
              <div className="empty-sub">Add your first PSA graded card to get started</div>
            </div>
          ) : (
            <div className="table-scroll">
              <div className="table-head">
                <div className="th">Card</div>
                <div className="th">Brand</div>
                <div className="th">Card #</div>
                <div className="th">Grade</div>
                <div className="th">Market Value</div>
                <div className="th">Cost Basis</div>
                <div className="th">Status</div>
                <div className="th"/>
              </div>
              {cards.map(card=>{
                const rowUnread=notifs.filter(n=>n.cardId===card.id&&!n.read).length;
                return (
                  <div className="table-row" key={card.id}>
                    <div>
                      <div className="card-name">
                        {card.player}
                        {rowUnread>0 && <span className="new-badge">{rowUnread} new</span>}
                      </div>
                      <div className="card-meta">{card.year}{card.quantity>1?` ¬∑ √ó${card.quantity}`:""}</div>
                    </div>
                    <div className="td">{card.brand||"‚Äî"}</div>
                    <div className="td">{card.cardNumber||"‚Äî"}</div>
                    <div><span className={`psa-badge ${getPsaClass(card.grade)}`}>{card.grade}</span></div>
                    <div>
                      <div className="td-value">{card.currentValue?fmt$(card.currentValue*(card.quantity||1)):"‚Äî"}</div>
                      {card.currentValue&&card.quantity>1&&<div className="card-meta">{fmt$(card.currentValue)} each</div>}
                      {card.salesNote&&<div className="card-meta" style={{fontSize:10,maxWidth:140,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}} title={card.salesNote}>{card.salesNote}</div>}
                    </div>
                    <div>
                      <div className="td">{card.pricePaid?fmt$(card.pricePaid*(card.quantity||1)):"‚Äî"}</div>
                      {card.currentValue&&card.pricePaid&&(
                        <div className="card-meta" style={{color:(card.currentValue-card.pricePaid)>=0?"var(--green)":"var(--red)"}}>
                          {(card.currentValue-card.pricePaid)>=0?"+":""}{fmt$((card.currentValue-card.pricePaid)*(card.quantity||1))}
                        </div>
                      )}
                    </div>
                    <div>
                      {loadingMap[card.id]||card.status==="loading"?(
                        <span className="status-pill status-loading"><span className="dot"/>Fetching</span>
                      ):card.status==="live"?(
                        <div>
                          <span className="status-pill status-live"><span className="dot"/>Live</span>
                          {card.lastUpdated&&<div className="card-meta" style={{marginTop:3}}>{fmtDate(card.lastUpdated)}</div>}
                        </div>
                      ):card.status==="error"?(
                        <span className="status-pill status-error"><span className="dot"/>Error</span>
                      ):(
                        <span className="status-pill status-pending"><span className="dot"/>Pending</span>
                      )}
                    </div>
                    <div style={{display:"flex",gap:5}}>
                      <button className="btn btn-ghost" onClick={()=>updateCard(card.id)} disabled={loadingMap[card.id]||updatingAll} title="Refresh" style={{padding:"3px 7px",fontSize:13}}>‚Üª</button>
                      <button className="btn btn-danger" onClick={()=>removeCard(card.id)}>‚úï</button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        <div className="alert alert-info">
          üîî CardVault checks for new eBay sales every 6 hours. New sales trigger bell alerts and pop-up toasts. Hit ‚Üª or "Update All" to check manually anytime.
        </div>
      </main>

      {/* Notification Drawer */}
      {showDrawer && (
        <>
          <div className="notif-overlay" onClick={()=>setShowDrawer(false)}/>
          <div className="notif-drawer">
            <div className="notif-header">
              <div className="notif-title">Sales Alerts</div>
              <div className="notif-hactions">
                {notifs.length>0&&<>
                  <button className="btn btn-ghost btn-xs" onClick={()=>saveNotifs(notifsRef.current.map(n=>({...n,read:true})))}>Mark read</button>
                  <button className="btn btn-danger btn-xs" onClick={()=>saveNotifs([])}>Clear all</button>
                </>}
                <button className="btn btn-ghost btn-xs" onClick={()=>setShowDrawer(false)}>‚úï</button>
              </div>
            </div>
            {notifs.length===0?(
              <div className="notif-empty">
                <div className="notif-empty-icon">üîî</div>
                <div className="notif-empty-text">No sales alerts yet.<br/>New eBay sold listings that match your cards will appear here.</div>
              </div>
            ):(
              <div className="notif-list">
                {[...notifs].reverse().map(n=>(
                  <div key={n.id} className={`notif-item ${n.read?"":"unread"}`}>
                    <div className="notif-card-name">{n.cardLabel}</div>
                    <div className="notif-price">{fmt$(n.sale.price)}</div>
                    <div className="notif-meta">Sold {n.sale.date} ¬∑ {n.sale.source}</div>
                    {n.previousValue!=null&&(
                      <div className="notif-vs">
                        <div>
                          <div className="notif-vs-label">Previous est.</div>
                          <div className="notif-vs-val">{fmt$(n.previousValue)}</div>
                        </div>
                        <div>
                          <div className="notif-vs-label">Difference</div>
                          <div className="notif-vs-val" style={{color:n.sale.price>=n.previousValue?"var(--green)":"var(--red)"}}>
                            {n.sale.price>=n.previousValue?"+":""}{fmt$(n.sale.price-n.previousValue)}
                          </div>
                        </div>
                      </div>
                    )}
                    <div className="notif-time">{timeAgo(n.seenAt)}</div>
                  </div>
                ))}
              </div>
            )}
            <div className="notif-footer">Auto-checks every 6 hrs ¬∑ Next in {fmtCountdown(countdown)}</div>
          </div>
        </>
      )}

      {/* Toasts */}
      <div className="toast-wrap">
        {toasts.map(t=>(
          <div key={t.id} className="toast">
            <div className="toast-eyebrow">üîî New Sale Detected</div>
            <div className="toast-card">{t.cardLabel}</div>
            <div className="toast-price">{fmt$(t.sale.price)}</div>
          </div>
        ))}
      </div>

      {/* Add Card Modal */}
      {showModal&&(
        <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&setShowModal(false)}>
          <div className="modal">
            <div className="modal-header">
              <div className="modal-title">Add PSA Card</div>
              <button className="btn btn-ghost" onClick={()=>setShowModal(false)}>‚úï</button>
            </div>
            <div className="modal-body">
              <div className="form-group">
                <label className="form-label">Player / Card Name *</label>
                <input className="form-input" placeholder="e.g. Michael Jordan" value={form.player} onChange={e=>setForm(f=>({...f,player:e.target.value}))}/>
              </div>
              <div className="form-row">
                <div className="form-group">
                  <label className="form-label">Year</label>
                  <input className="form-input" placeholder="e.g. 1986" value={form.year} onChange={e=>setForm(f=>({...f,year:e.target.value}))}/>
                </div>
                <div className="form-group">
                  <label className="form-label">Brand / Set</label>
                  <input className="form-input" placeholder="e.g. Topps" value={form.brand} onChange={e=>setForm(f=>({...f,brand:e.target.value}))}/>
                </div>
              </div>
              <div className="form-row">
                <div className="form-group">
                  <label className="form-label">Card Number</label>
                  <input className="form-input" placeholder="e.g. 57" value={form.cardNumber} onChange={e=>setForm(f=>({...f,cardNumber:e.target.value}))}/>
                </div>
                <div className="form-group">
                  <label className="form-label">PSA Grade</label>
                  <select className="form-select" value={form.grade} onChange={e=>setForm(f=>({...f,grade:e.target.value}))}>
                    {PSA_GRADES.map(g=><option key={g} value={g}>PSA {g}</option>)}
                  </select>
                </div>
              </div>
              <div className="form-row">
                <div className="form-group">
                  <label className="form-label">Quantity</label>
                  <input className="form-input" type="number" min="1" value={form.quantity} onChange={e=>setForm(f=>({...f,quantity:e.target.value}))}/>
                </div>
                <div className="form-group">
                  <label className="form-label">Price Paid (per card)</label>
                  <input className="form-input" type="number" placeholder="e.g. 150.00" value={form.pricePaid} onChange={e=>setForm(f=>({...f,pricePaid:e.target.value}))}/>
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <button className="btn btn-ghost" onClick={()=>setShowModal(false)}>Cancel</button>
              <button className="btn btn-gold" onClick={addCard} disabled={!form.player.trim()}>Add to Collection</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
